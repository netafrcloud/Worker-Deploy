name: Deploy Multi-Domain Worker

on:
  workflow_dispatch:
    inputs:
      worker_name:
        description: 'Nama Worker'
        required: true
        type: string
      cloudflare_account_id:
        description: 'Cloudflare Account ID'
        required: true
        type: string
      cloudflare_api_token:
        description: 'Cloudflare API Token'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Membuat package.json jika tidak ada
        id: check_package_json
        run: |
          if [ ! -f "package.json" ]; then
            echo "File package.json tidak ditemukan, membuat file baru..."
            npm init -y
            npm install wrangler@latest
          else
            echo "File package.json sudah ada."
          fi

      - name: Dynamic Wrangler.toml from main_domains.txt and customdomain.txt
        run: |
          # Periksa apakah file data ada
          if [ ! -f "main_domains.txt" ]; then
            echo "::error file=main_domains.txt::File main_domains.txt tidak ditemukan. Silakan buat file yang berisi domain utama (satu per baris)."
            exit 1
          fi
          
          # Buat header wrangler.toml
          echo "name = \"${{ inputs.worker_name }}\"" > wrangler.toml
          echo "main = \"worker.js\"" >> wrangler.toml
          echo "compatibility_date = \"2024-01-15\"" >> wrangler.toml
          echo "compatibility_flags = [\"nodejs_compat\"]" >> wrangler.toml
          echo "workers_dev = true" >> wrangler.toml
          echo "" >> wrangler.toml
          
          # Tambahkan Routes
          echo "routes = [" >> wrangler.toml

          # Loop utama: Iterasi melalui setiap domain dari main_domains.txt
          while IFS= read -r main_domain; do
            main_domain=$(echo "$main_domain" | xargs) # Hapus spasi di awal/akhir
            if [[ -n "$main_domain" ]]; then
              
              # 1. Tambahkan rute untuk domain utama itu sendiri
              echo "  { pattern = \"$main_domain\", custom_domain = true }," >> wrangler.toml
              
              # 2. Loop sekunder: Iterasi melalui setiap sub-domain dari customdomain.txt
              if [ -f "customdomain.txt" ]; then
                while IFS= read -r subdomain_prefix; do
                  subdomain_prefix=$(echo "$subdomain_prefix" | xargs)
                  if [[ -n "$subdomain_prefix" ]]; then
                    echo "  { pattern = \"$subdomain_prefix.$main_domain\", custom_domain = true }," >> wrangler.toml
                  fi
                done < customdomain.txt
              else
                echo "customdomain.txt tidak ditemukan, melanjutkan tanpa sub-domain."
              fi
            fi
          done < main_domains.txt

          # Hapus koma terakhir dari baris terakhir
          sed -i '$ s/,$//' wrangler.toml
          
          # Tutup array routes dan tambahkan konfigurasi tambahan
          echo "]" >> wrangler.toml
          echo "" >> wrangler.toml
          echo "[build]" >> wrangler.toml
          echo "command = \"\"" >> wrangler.toml
          echo "" >> wrangler.toml


      - name: Display Wrangler.toml for debugging
        run: |
          echo "--- Generated wrangler.toml content ---"
          cat wrangler.toml
          echo "-------------------------------------"

      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ inputs.cloudflare_api_token }}
          accountId: ${{ inputs.cloudflare_account_id }}
