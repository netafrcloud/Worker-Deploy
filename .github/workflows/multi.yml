name: Deploy Chunked Multi-Domain Worker

on:
  workflow_dispatch:
    inputs:
      worker_name:
        description: 'Nama Worker'
        required: true
        type: string
      cloudflare_account_id:
        description: 'Cloudflare Account ID'
        required: true
        type: string
      cloudflare_api_token:
        description: 'Cloudflare API Token'
        required: true
        type: string
      # Input opsional untuk mengatur ukuran chunk
      chunk_size:
        description: 'Jumlah Domain per deployment API Call (Default: 50)'
        required: false
        default: '50'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and Install Wrangler
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler CLI
        run: |
          # Memastikan Wrangler tersedia untuk digunakan dalam loop
          npm install wrangler@latest
          
      - name: Dynamic Chunked Deployment
        env:
          CLOUDFLARE_API_TOKEN: ${{ inputs.cloudflare_api_token }}
          CLOUDFLARE_ACCOUNT_ID: ${{ inputs.cloudflare_account_id }}
          CHUNK_SIZE: ${{ inputs.chunk_size }}
          WORKER_NAME: ${{ inputs.worker_name }}
        run: |
          echo "Memulai deployment bertahap (chunked deployment)."

          # 1. Pastikan file data ada
          if [ ! -f "main_domains.txt" ]; then
            echo "::error file=main_domains.txt::File main_domains.txt tidak ditemukan."
            exit 1
          fi

          # 2. Bagi main_domains.txt menjadi chunk files (misalnya, 50 baris per file)
          split -l $CHUNK_SIZE main_domains.txt domain_chunk_

          # 3. Loop melalui setiap chunk file yang dihasilkan
          for chunk_file in domain_chunk_*; do
            
            echo "--------------------------------------------------------"
            echo "Memproses chunk file: $chunk_file"
            
            # --- MULAI PEMBUATAN WRANGLER.TOML SEMENTARA ---
            
            # Buat header wrangler.toml (selalu ditulis ulang)
            echo "name = \"$WORKER_NAME\"" > wrangler.toml
            echo "main = \"worker.js\"" >> wrangler.toml
            echo "compatibility_date = \"2024-01-15\"" >> wrangler.toml
            echo "compatibility_flags = [\"nodejs_compat\"]" >> wrangler.toml
            echo "workers_dev = true" >> wrangler.toml
            echo "" >> wrangler.toml
            echo "routes = [" >> wrangler.toml
            
            # Loop ganda: Main Domain (dari chunk) dan Sub-Domain (dari customdomain.txt)
            while IFS= read -r main_domain; do
              main_domain=$(echo "$main_domain" | xargs)
              if [[ -n "$main_domain" ]]; then
                
                # Tambahkan rute domain utama
                echo "  { pattern = \"$main_domain\", custom_domain = true }," >> wrangler.toml
                
                # Tambahkan rute sub-domain
                if [ -f "customdomain.txt" ]; then
                  while IFS= read -r subdomain_prefix; do
                    subdomain_prefix=$(echo "$subdomain_prefix" | xargs)
                    if [[ -n "$subdomain_prefix" ]]; then
                      echo "  { pattern = \"$subdomain_prefix.$main_domain\", custom_domain = true }," >> wrangler.toml
                    fi
                  done < customdomain.txt
                fi
              fi
            done < "$chunk_file"

            # Hapus koma terakhir dari baris terakhir untuk validasi TOML
            sed -i '$ s/,$//' wrangler.toml
            
            # Tutup array routes dan tambahkan build config
            echo "]" >> wrangler.toml
            echo "" >> wrangler.toml
            echo "[build]" >> wrangler.toml
            echo "command = \"\"" >> wrangler.toml
            echo "" >> wrangler.toml

            # --- AKHIR PEMBUATAN WRANGLER.TOML SEMENTARA ---

            echo "Rute yang dihasilkan di wrangler.toml:"
            cat wrangler.toml

            # 4. DEPLOY menggunakan Wrangler CLI
            # Cloudflare API Token dan Account ID diakses melalui environment variables
            echo "Mendeploy Worker untuk chunk $chunk_file..."
            npx wrangler deploy --config wrangler.toml
            echo "Deployment chunk $chunk_file selesai."
            
            # --- SOLUSI BARU: Tambahkan delay 10 detik antar chunk untuk menghindari timeout API ---
            echo "Menunggu 10 detik sebelum memproses chunk berikutnya..."
            sleep 10
            
          done
          
          # Hapus file chunk sementara setelah selesai
          rm domain_chunk_*
          echo "Semua deployment selesai."
